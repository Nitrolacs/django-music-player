{% load static %}
{% load music_tag %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Django Music Player</title>
    <link rel="stylesheet" href=" {% static 'main/css/style.css' %} ">
</head>
<body>
<header>
    <div class="header_logo">
        Django Music Player
    </div>
</header>

<div class="player">
    <div class="imgbox">
        <img src="{% static 'main/media/$_10.JPG' %}" alt="music cover">
    </div>
    <p class="songname">The Grid (из фильма «ТРОН: Наследие»)</p>
    <p class="songauthor">Daft Punk</p>
    <div class="middle">
        <div class="slider-container">
            <span class="bar"><span class="fill"></span></span>
            <input id="slider" class="slider" type="range" min="0" max="100" value="0">

        </div>
    </div>
    <div class="timer">
        <span class="current-time">0:30</span>
        <span class="total_duration">1:05</span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.slim.min.js"></script>
    <script>
        var $slider = $("#slider");
        var $fill = $(".bar .fill");

        function setBar() {
            $fill.css("width", $slider.val() + "%");
        }

        $slider.on("input", setBar);
        setBar();
    </script>

    <div class="buttons">
        <div class="prev-track"><img src="{% static 'main/media/previous.svg' %}" alt="prev"></div>
        <div class="play-track"><img src="{% static 'main/media/play.svg' %}" alt="play"></div>
        <div class="next-track"><img src="{% static 'main/media/next-track.svg' %}" alt="next "></div>
    </div>


</div>

<div class="music-list">
    <div class="playlist-information">
        <div class="small-img-box">
            <img src="{% static 'main/media/$_10.JPG' %}" alt="small-img-box">
        </div>
        <div class="small-playlist-info">
            <p class="songname" style="margin-top: 23px">Tron: Legacy - The Complete Edition</p>
            <p class="songauthor">Daft Punk</p>
        </div>
    </div>

    <ul class="songs">

        {% for comp in composition %}

            <li class="song">
                <div style="cursor: pointer; margin-left: 9px;"><img src="{% static 'main/media/icon1.svg' %}"
                                                                     alt="play">
                </div>
                <p class="song-name" style="margin-left: 14px; width: 185px">{{ comp.title }} - {{ comp.artist }}</p>
                <p class="song-name" style="margin-right: 3px">{{ comp.time_length | time_formatter }}</p>
                <div style="cursor: pointer; margin-left: 7px"><img src="{% static 'main/media/download.svg' %}"
                                                                    alt="download"></div>
                <div style="cursor: pointer; margin-left: 8px; margin-top: -8px"><img
                        src="{% static 'main/media/minus.svg' %}" alt="minus">
                </div>
            </li>

        {% endfor %}


    </ul>


</div>

<audio class="audio-player" preload="metadata" src='/main/static/main/media/TRON_Legacy_-_The_Grid_(Long_Version).mp3'></audio>

{{ composition_list | json_script:"musics" }}

<script>

    const player = document.querySelector('.audio-player')
    const play = document.querySelector('.play-track')
    const prev = document.querySelector('.prev-track')
    const next = document.querySelector('.next-track')
    const duration = document.querySelector('.total_duration')
    const currentTime = document.querySelector('.current-time')
    const progress = document.querySelector('.slider')
    const progress_container = document.querySelector('.slider-container')
    const audio_tracks = document.querySelector('.songs')
    const song_title = document.querySelector('.songname')
    const artist = document.querySelector('.songauthor')
    const playlist = document.querySelector('.playlist-information')
    const music_img = document.querySelector('.imgbox')

    // init music indexing
    let compositionIndex = 0

    // get music from DOM
    const musics = JSON.parse(document.getElementById('musics').textContent)

    // functions
    const setSRC = () => {
        player.src = `{{ MEDIA_URL }}/${musics[compositionIndex].audio_file}`
        song_title.textContent = musics[compositionIndex].title
        artist.textContent = musics[compositionIndex].artist
        music_img.setAttribute('src', `{{ MEDIA_URL }}/${musics[compositionIndex].cover_image}`)
        if (musics[compositionIndex].playlist != null) {
            playlist.textContent = musics[compositionIndex].playlist
        } else {
            playlist.textContent = "Single"
        }
    }

    const playOrPause = () => {
        if (player.paused) {
            player.play()
        } else {
            player.pause()
        }
    }

    const formatTime = (secs) => {
        let min = Math.floor((secs % 3600) / 60)
        let sec = Math.floor(secs % 60)
        if (sec < 10) {
            sec = `0${sec}`
        }
        return `${min}:${sec}`
    }

    // load music on refresh
    setSRC()
    player.pause()

    // when play is clicked
    play.addEventListener('click', () => {
        playOrPause()
    })

</script>

</body>

</html>